FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update

RUN apt-get install -y --no-install-recommends curl python3 python3-pip python3-setuptools git wget make ffmpeg ca-certificates curl gnupg

### Install items needed for frontend (Node.js, npm)
RUN mkdir -p /etc/apt/keyrings
RUN curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
RUN echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list
RUN apt-get update && apt-get install nodejs -y

RUN node -v
RUN npm -v

WORKDIR /Mocap/frontend/annotation
COPY frontend/annotation/package*.json /Mocap/frontend/annotation/
RUN npm install
COPY frontend/annotation /Mocap/frontend/annotation

### Installing extra things (curl, screen, netstat) (can be removed after image is in stable state)
RUN apt-get install -y net-tools

### Install EasyMocap
WORKDIR /
RUN git clone https://github.com/peabody124/EasyMocap
RUN pip install --upgrade pip
RUN pip install -e /EasyMocap

RUN git clone https://github.com/IntelligentSensingAndRehabilitation/PosePipeline.git
RUN pip install -e /PosePipeline

### Install MultiCameraTracking package and dependencies

WORKDIR /Mocap
COPY pyproject.toml README.md /Mocap/
COPY multi_camera /Mocap/multi_camera
COPY model_data /Mocap/model_data
RUN pip3 install -e /Mocap/

WORKDIR /
RUN mkdir -p /data
RUN mkdir -p /configs

# A hack currently, to have a local .datajoint_config.json replace the default one from posepipe
COPY datajoint_config.json /root/.datajoint_config.json

# Copy annotation entrypoint script
COPY docker/entrypoints/run_annotate.sh /Mocap/entrypoints/run_annotate.sh
RUN chmod +x /Mocap/entrypoints/run_annotate.sh

# # Run bash script to start front end and back end
ENTRYPOINT ["/bin/bash"]
CMD ["/Mocap/entrypoints/run_annotate.sh"]
