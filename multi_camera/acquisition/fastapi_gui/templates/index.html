<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-camera Video Acquisition System</title>
    <script src="https://cdn.socket.io/4.1.2/socket.io.min.js"></script>
</head>

<body>

    <div>
        <label for="config">Config:</label>
        <select id="config">
            <!-- options will be added by the backend -->
        </select>
    </div>

    <div>
        <label for="participant_identifier">Participant Identifier:</label>
        <input id="participant_identifier" type="text" />
    </div>


    <div>
        <button id="new_session">New Session</button>
        <label for="session_dir">Recording Directory:</label>
        <input id="session_dir" type="text" />
        <label for="session_filename">Base Filename:</label>
        <input id="session_filename" type="text" />
    </div>

    <div>
        <button id="new_trial">New Trial</button>
        <button id="stop">Stop Recording</button>
        <label for="file_name">File Name:</label>
        <input id="file_name" type="text" readonly />
        <label for="comment">Comment:</label>
        <input id="comment" type="text" />
    </div>

    <div>
        <label for="status">Status:</label>
        <input id="status" type="text" readonly />
    </div>


    <div>
        <label for="channel">Select channel:</label>
        <select id="channel">
            <!-- Add options for each channel -->
            <option value="0">Channel 0</option>
            <option value="1">Channel 1</option>
        </select>
        <br />
        <img id="video_stream" width="640">
    </div>

    <table>
        <tr>
            <td>
                <h3>Prior Recordings:</h3>
            </td>
        </tr>
        <tr>
            <td>
                <table id="previous_recordings">
                    <thead>
                        <tr>
                            <th>Participant</th>
                            <th>Filename</th>
                            <th>Comment</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- rows will be added by the backend -->
                    </tbody>
                </table>
            </td>
        </tr>
    </table>


    <script>
        const API_ENDPOINT = "/api/v1"; // Define the API endpoint path

        const video = document.getElementById("video");
        const channelSelector = document.getElementById("channel");
        const startButton = document.getElementById("start");
        const stopButton = document.getElementById("stop");
        const participantIdentifierInput = document.getElementById("participant_identifier");
        const sessionDirInput = document.getElementById("session_dir");
        const sessionFilenameInput = document.getElementById("session_filename");
        const newSessionButton = document.getElementById("new_session");
        const newTrialButton = document.getElementById("new_trial");
        const statusInput = document.getElementById("status");
        const commentInput = document.getElementById("comment");
        const configSelect = document.getElementById("config");
        const fileNameInput = document.getElementById("file_name");

        async function sendData(url, data) {
            const response = await fetch(`${API_ENDPOINT}${url}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            });
            return response.json();
        }

        newSessionButton.addEventListener("click", () => {
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            const sessionId = `${participantIdentifierInput.value}/${date}`;
            sessionDirInput.value = sessionId;
            sessionFilenameInput.value = `${participantIdentifierInput.value}_${date}`;
        });

        newTrialButton.addEventListener("click", () => {
            const config = configSelect.value;
            const sessionId = sessionDirInput.value;
            const trialFilename = `${sessionFilenameInput.value}_${new Date().toISOString().replace(/[-:.]/g, "")}`;
            const comment = commentInput.value;

            sendData("/start", {
                recording_dir: sessionId, recording_filename: trialFilename, config_file: config,
                comment: comment
            })
                .then(data => {
                    statusInput.value = "recording...";
                    fileNameInput.value = trialFilename;
                });
        });

        stopButton.addEventListener("click", () => {
            sendData("/stop", {}).then(data => {
                statusInput.value = "recording stopped";
            });
        });

        fetch(`${API_ENDPOINT}/configs`)
            .then(response => response.json())
            .then(data => {
                data.forEach(config => {
                    const option = document.createElement("option");
                    option.value = config;
                    option.text = config;
                    configSelect.add(option);
                });
            });

        fetch(`${API_ENDPOINT}/recordings`)
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById("previous_recordings");
                data.forEach(recording => {
                    const row = table.insertRow();
                    const participantCell = row.insertCell(0);
                    const filenameCell = row.insertCell(1);
                    const commentCell = row.insertCell(2);
                    participantCell.innerHTML = recording.participant;
                    filenameCell.innerHTML = recording.filename;
                    commentCell.innerHTML = recording.comment;
                });
            });

        // Connect up for recording
        const videoStream = document.getElementById("video_stream");

        // Set the image source to the video stream endpoint
        videoStream.src = `http://localhost:8000${API_ENDPOINT}/video`;
    </script>
</body>

</html>